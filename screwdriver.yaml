shared:
    image: node:8

jobs:
    main:
        requires: [~pr, ~commit]
        environment:
            SD_SONAR_OPTS: "-Dsonar.sources=index.js"
        steps:
            - echo: echo $SONAR_OPTS
            - install: npm install
            - test: npm test || true
            - sonar-test-results-formatter: node_modules/.bin/mocha --reporter mocha-sonarqube-reporter test --reporter-options output=sonar/xunit.xml || true
            - coverage-bookend: if [ `uname` = 'Darwin' ]; then echo "ERROR - coverage feature not implemented." && exit 0; fi &&  if [ ! -f sonar-project.properties ] && [ -z $SONAR_OPTS ]; then echo "ERROR - No sonar project properties defined." && exit 0; fi && export SD_CURL_CMD_WRAPPER="sd-step exec --pkg-version 7.54.1 core/curl" && export SD_UNZIP_CMD_WRAPPER="sd-step exec --pkg-version 6.0 core/unzip" && $SD_CURL_CMD_WRAPPER "curl -o ./sonarscanner.zip -L https://sonarsource.bintray.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-3.1.0.1141-linux.zip" && $SD_UNZIP_CMD_WRAPPER "unzip -q ./sonarscanner.zip" && sonar-scanner-3.1.0.1141-linux/bin/sonar-scanner -Dsonar.host.url=https://sonar.screwdriver.cd -Dsonar.login=$SONAR_TOKEN -Dsonar.projectKey="job:$SD_JOB_ID" -Dsonar.projectName="$SD_PIPELINE_NAME:$SD_JOB_NAME" -Dsonar.projectVersion=$SD_BUILD_SHA $SD_SONAR_OPTS || true
        secrets:
            - SONAR_TOKEN
